# アーキテクチャ概要

Zero to Snowflake ハンズオンで使用するアーキテクチャの詳細説明です。

---

## 🏗️ 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Snowflake Account                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        TB_101 Database                               │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│  │  │   raw_pos   │  │raw_customer │  │ raw_support │                │   │
│  │  │             │  │             │  │             │                │   │
│  │  │ • country   │  │ • customer_ │  │ • truck_    │                │   │
│  │  │ • franchise │  │   loyalty   │  │   reviews   │                │   │
│  │  │ • location  │  │             │  │             │                │   │
│  │  │ • menu      │  └─────────────┘  └─────────────┘                │   │
│  │  │ • truck     │                                                   │   │
│  │  │ • order_    │                                                   │   │
│  │  │   header    │                                                   │   │
│  │  │ • order_    │                                                   │   │
│  │  │   detail    │                                                   │   │
│  │  └──────┬──────┘                                                   │   │
│  │         │                                                          │   │
│  │         ▼                                                          │   │
│  │  ┌─────────────────────────────────────────────────────────────┐  │   │
│  │  │                    harmonized                                │  │   │
│  │  │                                                             │  │   │
│  │  │  • orders_v                    • daily_weather_v            │  │   │
│  │  │  • customer_loyalty_metrics_v  • tastybytes_poi_v           │  │   │
│  │  │  • truck_reviews_v             • ingredient (Dynamic)       │  │   │
│  │  │                                • ingredient_to_menu_lookup  │  │   │
│  │  │                                • ingredient_usage_by_truck  │  │   │
│  │  └──────────────────────┬──────────────────────────────────────┘  │   │
│  │                         │                                          │   │
│  │                         ▼                                          │   │
│  │  ┌─────────────────────────────────────────────────────────────┐  │   │
│  │  │                     analytics                                │  │   │
│  │  │                                                             │  │   │
│  │  │  • orders_v                    • daily_sales_by_weather_v   │  │   │
│  │  │  • customer_loyalty_metrics_v  • japan_menu_item_sales      │  │   │
│  │  │  • truck_reviews_v                                          │  │   │
│  │  └─────────────────────────────────────────────────────────────┘  │   │
│  │                                                                     │   │
│  │  ┌─────────────┐  ┌──────────────────┐                            │   │
│  │  │  governance │  │  semantic_layer  │                            │   │
│  │  │             │  │                  │                            │   │
│  │  │ • pii tag   │  │ • orders_v       │                            │   │
│  │  │ • policies  │  │ • customer_      │                            │   │
│  │  │ • DMF       │  │   metrics_v      │                            │   │
│  │  └─────────────┘  └──────────────────┘                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    External Data (Marketplace)                       │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │  ┌─────────────────────┐    ┌─────────────────────┐               │   │
│  │  │  ZTS_WEATHERSOURCE  │    │    ZTS_SAFEGRAPH    │               │   │
│  │  │                     │    │                     │               │   │
│  │  │ • history_day       │    │ • frostbyte_tb_     │               │   │
│  │  │ • postal_codes      │    │   safegraph_s       │               │   │
│  │  └─────────────────────┘    └─────────────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 👥 ロール階層

```
                    ┌───────────────┐
                    │ ACCOUNTADMIN  │
                    └───────┬───────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
            ▼               ▼               ▼
    ┌───────────────┐ ┌───────────┐ ┌───────────┐
    │ SECURITYADMIN │ │ SYSADMIN  │ │ USERADMIN │
    └───────┬───────┘ └─────┬─────┘ └───────────┘
            │               │
            │       ┌───────┴───────┐
            │       │               │
            │       ▼               │
            │ ┌───────────┐         │
            │ │ TB_ADMIN  │◀────────┘
            │ └─────┬─────┘
            │       │
            │       ▼
            │ ┌────────────────────┐
            │ │ TB_DATA_ENGINEER   │
            │ └─────┬──────┬───────┘
            │       │      │
            │       ▼      ▼
            │ ┌────────┐ ┌───────────┐
            │ │ TB_DEV │ │ TB_ANALYST│
            │ └────────┘ └───────────┘
            │
            ▼
    ┌─────────────────┐
    │ TB_DATA_STEWARD │  (Module 04で作成)
    └─────────────────┘
```

### ロール説明

| ロール | 説明 | 主な権限 |
|--------|------|----------|
| `ACCOUNTADMIN` | 最上位管理者 | すべての権限 |
| `SYSADMIN` | システム管理者 | WH/DB作成 |
| `SECURITYADMIN` | セキュリティ管理者 | ロール/権限管理 |
| `TB_ADMIN` | TB管理者 | TB環境の管理 |
| `TB_DATA_ENGINEER` | データエンジニア | ETL/パイプライン |
| `TB_DEV` | 開発者 | 開発環境アクセス |
| `TB_ANALYST` | アナリスト | 分析クエリ |
| `TB_DATA_STEWARD` | データスチュワード | ガバナンス管理 |

---

## 🗄️ スキーマ構成

### raw_pos（生データ - POS）

| テーブル | 説明 | 主要カラム |
|----------|------|-----------|
| `country` | 国・都市マスタ | country_id, country, city |
| `franchise` | フランチャイズ情報 | franchise_id, first_name, last_name |
| `location` | ロケーション情報 | location_id, city, country |
| `menu` | メニュー情報 | menu_id, menu_item_name, sale_price |
| `truck` | トラック情報 | truck_id, primary_city, franchise_id |
| `order_header` | 注文ヘッダー | order_id, truck_id, order_ts |
| `order_detail` | 注文明細 | order_detail_id, order_id, quantity |

### raw_customer（生データ - 顧客）

| テーブル | 説明 | 主要カラム |
|----------|------|-----------|
| `customer_loyalty` | ロイヤルティ会員 | customer_id, first_name, email |

### raw_support（生データ - サポート）

| テーブル | 説明 | 主要カラム |
|----------|------|-----------|
| `truck_reviews` | トラックレビュー | review_id, review, language |

### harmonized（統合データ）

| オブジェクト | タイプ | 説明 |
|-------------|--------|------|
| `orders_v` | View | 注文統合ビュー |
| `customer_loyalty_metrics_v` | View | 顧客メトリクス |
| `truck_reviews_v` | View | レビュー統合 |
| `daily_weather_v` | View | 日次天気 |
| `tastybytes_poi_v` | View | POI統合 |
| `ingredient` | Dynamic Table | 成分マスタ |
| `ingredient_to_menu_lookup` | Dynamic Table | 成分→メニュー |
| `ingredient_usage_by_truck` | Dynamic Table | 成分使用量 |

### analytics（分析用）

| オブジェクト | タイプ | 説明 |
|-------------|--------|------|
| `orders_v` | View | 分析用注文ビュー |
| `customer_loyalty_metrics_v` | View | 顧客分析 |
| `truck_reviews_v` | View | レビュー分析 |
| `daily_sales_by_weather_v` | View | 天気×売上 |

---

## ⚙️ ウェアハウス構成

| ウェアハウス | サイズ | 用途 |
|-------------|--------|------|
| `TB_DE_WH` | Large→XSmall | データエンジニアリング、初期ロード |
| `TB_DEV_WH` | X-Small | 開発・テスト |
| `TB_ANALYST_WH` | Large | 分析クエリ、Cortex AI |
| `TB_CORTEX_WH` | Large | Cortex Analyst |

---

## 🔄 データフロー

### ETLパイプライン（Module 02）

```
S3 Bucket
    │
    ▼
┌─────────────┐
│   Stage     │
│ (menu_stage)│
└──────┬──────┘
       │ COPY INTO
       ▼
┌─────────────────┐
│ menu_staging    │
│ (Staging Table) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌──────────────────────────┐
│   ingredient    │────▶│ ingredient_to_menu_lookup│
│ (Dynamic Table) │     │    (Dynamic Table)       │
└─────────────────┘     └───────────┬──────────────┘
                                    │
                                    ▼
                        ┌──────────────────────────┐
                        │ ingredient_usage_by_truck│
                        │    (Dynamic Table)       │
                        └──────────────────────────┘
```

### AI分析フロー（Module 03）

```
┌─────────────────┐
│ truck_reviews_v │
└────────┬────────┘
         │
    ┌────┼────┬────────┬───────────┐
    │    │    │        │           │
    ▼    ▼    ▼        ▼           ▼
┌──────┐ ┌─────────┐ ┌─────────┐ ┌───────────┐
│SENTI-│ │AI_CLAS- │ │EXTRACT_ │ │AI_SUMMA-  │
│MENT  │ │SIFY     │ │ANSWER   │ │RIZE_AGG   │
└──────┘ └─────────┘ └─────────┘ └───────────┘
    │         │           │            │
    ▼         ▼           ▼            ▼
 スコア    カテゴリ    具体的回答     要約
(-1〜+1)  (分類結果)  (抽出結果)   (集約結果)
```

---

## 🛡️ セキュリティアーキテクチャ（Module 04）

```
┌─────────────────────────────────────────────────────────────┐
│                    セキュリティレイヤー                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                           │
│  │ 自動分類    │                                           │
│  │             │                                           │
│  │ NAME        │                                           │
│  │ EMAIL       │──────┐                                    │
│  │ PHONE       │      │                                    │
│  │ ...         │      │                                    │
│  └─────────────┘      │                                    │
│                       ▼                                    │
│              ┌─────────────┐                               │
│              │   PIIタグ   │                               │
│              └──────┬──────┘                               │
│                     │                                      │
│         ┌───────────┼───────────┐                         │
│         ▼           ▼           ▼                         │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐            │
│  │ マスキング │ │ 行アクセス │ │ DMF        │            │
│  │ ポリシー   │ │ ポリシー   │ │ (品質監視) │            │
│  └────────────┘ └────────────┘ └────────────┘            │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │               トラストセンター                        │   │
│  │  • CIS Benchmarks  • Security Essentials            │   │
│  │  • Threat Intelligence                              │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🌐 外部連携（Module 05）

```
┌──────────────────────────────────────────────────────────────────┐
│                     Snowflake Marketplace                         │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────┐      ┌────────────────────┐             │
│  │   Weather Source   │      │     Safegraph      │             │
│  │                    │      │                    │             │
│  │ • history_day      │      │ • POI data         │             │
│  │ • postal_codes     │      │ • location info    │             │
│  └─────────┬──────────┘      └─────────┬──────────┘             │
│            │                           │                         │
│            │     ┌──────────┐          │                         │
│            └────▶│  JOIN    │◀─────────┘                         │
│                  └────┬─────┘                                    │
│                       │                                          │
│                       ▼                                          │
│            ┌──────────────────┐                                 │
│            │  TB_101 Data     │                                 │
│            │  (orders_v)      │                                 │
│            └────────┬─────────┘                                 │
│                     │                                            │
│                     ▼                                            │
│            ┌──────────────────┐                                 │
│            │ 統合分析結果      │                                 │
│            │ • 天気×売上      │                                 │
│            │ • POI×天気      │                                 │
│            └──────────────────┘                                 │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

