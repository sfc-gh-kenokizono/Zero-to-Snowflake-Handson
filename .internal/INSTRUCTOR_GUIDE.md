# インストラクターガイド

このドキュメントは、Zero to Snowflake ハンズオンを実施するインストラクター向けのガイドです。
**お客様には共有しないでください。**

---

## 📋 ハンズオン実施前の準備

### 1. 環境確認（1週間前）

- [ ] 参加者全員がSnowflakeアカウントにアクセスできることを確認
- [ ] トライアルアカウントの場合、有効期限を確認
- [ ] 必要なロール（ACCOUNTADMIN）へのアクセス権限を確認
- [ ] Cortex AI機能が利用可能なリージョンであることを確認

### 2. 事前セットアップ（当日または前日）

参加者に事前にセットアップを完了してもらうか、ハンズオン冒頭で実施するかを決定してください。

**オプションA: 事前セットアップ（推奨）**
- セットアップ手順書を事前配布
- 当日は「✅ セットアップが完了しました！」メッセージの確認のみ

**オプションB: 当日セットアップ**
- 追加で15-20分の時間を確保
- ネットワーク負荷に注意

### 3. 資料準備

- [ ] 各モジュールのスライド（PDF）を確認
- [ ] SQLスクリプトの動作確認
- [ ] デモ用アカウントでの事前実行

---

## ⏱️ タイムテーブル例

### 90分クイックコース（推奨）

| 時間 | 内容 | モジュール |
|-----|------|----------|
| 0:00-0:05 | オープニング | - |
| 0:05-0:20 | 環境確認・セットアップ | 00_setup |
| 0:20-1:05 | Snowflakeの基本操作 | 01_getting_started |
| 1:05-1:25 | Cortex AI SQL関数 | 03_cortex_ai |
| 1:25-1:30 | クロージング | - |

### 半日コース（3.5時間）

| 時間 | 内容 | 備考 |
|-----|------|------|
| 0:00-0:15 | オープニング・環境確認 | 接続確認、質問対応 |
| 0:15-1:00 | Module 01: Snowflakeを始める | 基本操作の習得 |
| 1:00-1:45 | Module 02: データパイプライン | Dynamic Tables |
| 1:45-2:00 | 休憩 | |
| 2:00-2:30 | Module 03: Cortex AI | AI SQL関数 |
| 2:30-3:15 | Module 04: ガバナンス | セキュリティ重視の場合は延長 |
| 3:15-3:30 | Module 05: アプリ・連携 / クロージング | 時間調整用 |

### 1日コース（6時間）

| 時間 | 内容 | 備考 |
|-----|------|------|
| 9:00-9:30 | オープニング・セットアップ | |
| 9:30-10:30 | Module 01: Snowflakeを始める | 詳細説明付き |
| 10:30-10:45 | 休憩 | |
| 10:45-12:00 | Module 02: データパイプライン | 演習時間を追加 |
| 12:00-13:00 | 昼休憩 | |
| 13:00-14:00 | Module 03: Cortex AI | デモ重視 |
| 14:00-15:15 | Module 04: ガバナンス | 実践演習 |
| 15:15-15:30 | 休憩 | |
| 15:30-16:30 | Module 05: アプリ・連携 | Marketplace体験 |
| 16:30-17:00 | Q&A・クロージング | |

---

# 📖 モジュール別詳細ガイド

---

## Module 00: セットアップ

### 📁 ファイル: `00_setup/00_setup.sql`

| セクション | 行番号 | 説明ポイント |
|-----------|--------|-------------|
| データベース作成 | 27-50 | TB_101データベースと7つのスキーマを作成 |
| ウェアハウス作成 | 52-88 | 4つのウェアハウス（用途別） |
| ロール作成 | 90-200 | ロール階層とRBACの基本 |
| データロード | 550-600 | S3からのCOPY INTO（約10-15分） |

### 💬 説明台本

> 「このセットアップでは、データベース、スキーマ、ウェアハウス、ロールを作成し、S3からサンプルデータをロードします。約6,200万件の注文データをロードしますので、10〜15分ほどかかります。」

### ⚠️ よくある問題

| 問題 | 原因 | 対処法 |
|-----|------|-------|
| 「Insufficient privileges」 | ロール権限不足 | ACCOUNTADMINで実行 |
| データロードが遅い | ネットワーク | 待つ（正常動作） |

---

## Module 01: Snowflakeを始める

### 📁 ファイル: `01_getting_started/01_getting_started.sql`

### セクション1: ウェアハウスの作成（行27-148）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 61 | `SHOW WAREHOUSES;` | 既存ウェアハウスの確認。セットアップで作成した4つが見える |
| 75-84 | `CREATE WAREHOUSE my_wh...` | **ポイント**: AUTO_SUSPEND=60秒、AUTO_RESUME=false |
| 92 | `USE WAREHOUSE my_wh;` | ウェアハウスを選択 |
| 98 | `SELECT * FROM raw_pos.truck_details;` | **エラーになる！** ウェアハウスが一時停止中 |
| 107 | `ALTER WAREHOUSE my_wh RESUME;` | 手動再開 |
| 113 | `ALTER WAREHOUSE my_wh SET AUTO_RESUME = TRUE;` | 自動再開を有効化 |
| 128 | `ALTER WAREHOUSE my_wh SET warehouse_size = 'XLarge';` | **デモ**: スケールアップ。実行中でも変更可能！ |
| 131-137 | トラックごとの売上クエリ | 6200万行を集計。XLなので数秒で完了 |

💬 **説明ポイント**:
> 「Snowflakeでは、ストレージとコンピュートが完全に分離されています。ウェアハウスはコンピュートリソースの単位で、サイズを自由に変更できます。XSmallからXLargeまで、サイズが1つ上がるごとにリソースとコストが2倍になります。」

---

### セクション2: クエリキャッシュ（行149-177）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| - | 同じクエリを再実行 | **デモ**: 2回目は劇的に速い！ |
| 179 | `ALTER WAREHOUSE my_wh SET warehouse_size = 'XSmall';` | 元に戻す |

💬 **説明ポイント**:
> 「同じクエリを2回実行してください。1回目は数秒かかりましたが、2回目はミリ秒で完了します。これがクエリ結果キャッシュです。24時間保持され、ウェアハウス間で共有されます。ダッシュボードやレポートで効果的です。」

🎯 **確認ポイント**: クエリ詳細パネルで実行時間を比較させる

---

### セクション3: ゼロコピークローン（行178-297）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 196 | `SELECT truck_build FROM raw_pos.truck_details;` | VARIANTデータの確認。JSONっぽい構造 |
| 217 | `CREATE TABLE raw_pos.truck_dev CLONE raw_pos.truck_details;` | **ポイント**: 即座に完了、追加ストレージゼロ |
| 233-235 | `ALTER TABLE ... ADD COLUMN` | 新しい列を追加 |
| 242-246 | `UPDATE ... SET year = truck_build:year::NUMBER` | **コロン演算子**: VARIANTからキーを抽出 |
| 252-257 | `SELECT make, COUNT(*)` | データ品質問題を発見（Ford と Ford_） |
| 265-267 | `UPDATE ... SET make = 'Ford' WHERE make = 'Ford_'` | データクレンジング |
| 279 | `ALTER TABLE ... SWAP WITH ...` | **ポイント**: アトミックにテーブルをスワップ |
| 296-299 | `DROP COLUMN`, `DROP TABLE` | クリーンアップ |

💬 **説明ポイント**:
> 「ゼロコピークローンは、追加ストレージなしでテーブルの完全なコピーを即座に作成します。開発環境の作成、テスト、バックアップに最適です。変更があった部分だけ新しいストレージが使われます。これはSnowflakeのマイクロパーティションアーキテクチャのおかげです。」

---

### セクション4: UNDROP（行298-323）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 299 | `DROP TABLE raw_pos.truck_details;` | **ドキドキポイント**: 本番テーブルを削除！ |
| 316 | `DESCRIBE TABLE raw_pos.truck_details;` | エラー確認 |
| 319 | `UNDROP TABLE raw_pos.truck_details;` | **復活！** |
| 322 | `SELECT * FROM raw_pos.truck_details;` | 復元確認 |

💬 **説明ポイント**:
> 「大変です！本番テーブルを誤って削除してしまいました！...でも大丈夫。UNDROPで復元できます。これはTime Travel機能の一部で、デフォルト24時間以内なら削除したオブジェクトを復元できます。」

🎭 **演出**: 「やってしまった！」→「復活！」の流れで盛り上げる

---

### セクション5: リソースモニター（行324-368）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 360-366 | `CREATE RESOURCE MONITOR...` | クレジット監視。75%で通知、90%で停止、100%で即停止 |
| 369-370 | `ALTER WAREHOUSE ... SET RESOURCE_MONITOR` | ウェアハウスに適用 |

💬 **説明ポイント**:
> 「クラウドではコスト管理が重要です。リソースモニターを使って、クレジット使用量のしきい値を設定し、通知や自動停止のアクションを定義できます。」

---

### セクション6: 予算（行369-413）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 387-388 | `CREATE SNOWFLAKE.CORE.BUDGET my_budget()` | 予算オブジェクト作成 |
| 390-432 | UIでの設定手順 | Snowsight UIで予算を設定 |

💬 **説明ポイント**:
> 「予算は、リソースモニターよりも柔軟なコスト管理機能です。任意のSnowflakeオブジェクトやサービスのコストを追跡できます。」

---

### セクション7: ユニバーサル検索（行414-437）

💬 **説明ポイント**:
> 「ユニバーサル検索を使うと、アカウント内のオブジェクトを簡単に検索できます。『truck』と入力すると、テーブル、ビュー、Marketplaceデータ、ドキュメントなどが一覧表示されます。」

---

## Module 02: データパイプライン

### 📁 ファイル: `02_data_pipelines/02_data_pipelines.sql`

### セクション1: 外部ステージ（行27-71）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 44-47 | `CREATE STAGE raw_pos.menu_stage URL = 's3://...'` | S3バケットへの参照 |
| 49-62 | `CREATE TABLE raw_pos.menu_staging` | **注目**: `menu_item_health_metrics_obj VARIANT` |
| 65-66 | `COPY INTO raw_pos.menu_staging FROM @raw_pos.menu_stage` | ステージからテーブルへロード |

💬 **説明ポイント**:
> 「ステージは、S3やAzure Blob、GCSなどの外部ストレージへの参照です。COPY INTOコマンドで、ステージからテーブルにデータをロードできます。」

---

### セクション2: 半構造化データ（行72-126）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 90 | `SELECT menu_item_health_metrics_obj FROM raw_pos.menu_staging;` | VARIANTの中身を確認 |
| 106-110 | コロン演算子と角括弧 | `obj:key`, `arr[0]`, `::TYPE` |
| 119-124 | `LATERAL FLATTEN` | **重要**: 配列を行に展開 |

💬 **説明ポイント**:
> 「Snowflakeは半構造化データ（JSON、Avro、Parquetなど）をVARIANTデータ型で格納できます。コロン演算子でキーにアクセスし、FLATTEN関数で配列を行に展開できます。ETL不要で、そのままクエリできるのがSnowflakeの強みです。」

---

### セクション3: Dynamic Tables（行127-217）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 148-163 | `CREATE DYNAMIC TABLE harmonized.ingredient LAG = '1 minute'` | **ポイント**: 宣言的ETL |
| 176-206 | `INSERT INTO raw_pos.menu_staging` | 新しいメニューを追加 |
| 214-215 | `SELECT * FROM harmonized.ingredient WHERE ingredient_name IN (...)` | **デモ**: 自動更新を確認（最大1分待つ） |

💬 **説明ポイント**:
> 「Dynamic Tablesは、Snowflakeの宣言的ETL機能です。SELECTでデータを定義し、LAGで更新頻度を指定するだけ。ソースデータが変わると自動的に更新されます。ストリームやタスクを書く必要がありません。」

⏱️ **待ち時間対策**: 更新を待つ間、Dynamic Tablesのアーキテクチャを説明

---

### セクション4: パイプライン構築（行218-334）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 227-237 | `CREATE DYNAMIC TABLE harmonized.ingredient_to_menu_lookup` | 2番目のDynamic Table |
| 248-277 | 注文データのINSERT | テスト用データ |
| 293-317 | `CREATE DYNAMIC TABLE harmonized.ingredient_usage_by_truck` | 3番目のDynamic Table（LAG = 2分） |
| 322-332 | 成分使用量クエリ | パイプラインの結果を確認 |

---

### セクション5: DAG可視化（行335-355）

💬 **説明ポイント**:
> 「Snowsightでは、Dynamic TablesのDAG（有向非巡回グラフ）を視覚化できます。Catalog → TB_101 → HARMONIZED → Dynamic Tables → INGREDIENT → Graphタブで確認してください。」

🖥️ **UIデモ**: DAGを画面共有で見せる

---

## Module 03: Cortex AI

### 📁 ファイル: `03_cortex_ai/03_cortex_ai.sql`

### セクション1: SENTIMENT（行27-105）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 39-57 | センチメント分析クエリ | 10,000件を一括分析 |
| 48 | `SNOWFLAKE.CORTEX.SENTIMENT(review)` | **関数**: -1（ネガティブ）〜+1（ポジティブ） |

💬 **説明ポイント**:
> 「SENTIMENT関数は、テキストの感情を-1から+1のスコアで返します。0.5以上がポジティブ、-0.5以下がネガティブです。機械学習の知識は不要、SQLを書くだけでAI分析ができます。」

---

### セクション2: AI_CLASSIFY（行107-156）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 86-89 | `AI_CLASSIFY(review, ['Food Quality', 'Pricing', ...])` | カテゴリを配列で指定 |

💬 **説明ポイント**:
> 「AI_CLASSIFY関数は、テキストを指定したカテゴリに自動分類します。キーワードマッチではなく、AIが意味を理解して分類します。」

---

### セクション3: EXTRACT_ANSWER（行158-229）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 137-140 | `EXTRACT_ANSWER(review, 'What specific improvement...')` | 質問を投げて回答を抽出 |

💬 **説明ポイント**:
> 「EXTRACT_ANSWER関数は、テキストに対して質問を投げ、回答を抽出します。長いレビューから具体的なアクションアイテムを特定するのに最適です。」

---

### セクション4: AI_SUMMARIZE_AGG（行231-305）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 173-174 | `AI_SUMMARIZE_AGG(review)` + `AI_TRANSLATE(..., 'ja')` | 要約 + 日本語翻訳 |

💬 **説明ポイント**:
> 「AI_SUMMARIZE_AGG関数は、複数のテキストを1つの要約にまとめます。AI_TRANSLATEと組み合わせれば、日本語に翻訳もできます。」

---

## Module 04: ガバナンス

### 📁 ファイル: `04_governance/04_governance.sql`

### セクション1: RBAC（行26-118）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 39 | `SHOW ROLES;` | 既存ロールの確認 |
| 42-43 | `CREATE ROLE tb_data_steward` | カスタムロールの作成 |
| 65 | `GRANT OPERATE, USAGE ON WAREHOUSE ... TO ROLE` | ウェアハウス権限 |
| 76-77 | `GRANT USAGE ON DATABASE/SCHEMA` | データベース権限 |
| 91 | `GRANT SELECT ON ALL TABLES` | テーブル権限 |
| 111 | `SELECT * FROM raw_customer.customer_loyalty` | **デモ**: PIIが丸見え！ |

💬 **説明ポイント**:
> 「Snowflakeは、ロールベースアクセス制御（RBAC）を採用しています。権限はロールに付与し、ロールをユーザーに付与します。ロール間で継承も可能です。」

---

### セクション2: 自動タグ付け（行119-204）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 143 | `CREATE TAG governance.pii` | PIIタグを作成 |
| 161-167 | `CREATE CLASSIFICATION_PROFILE` | 分類プロファイル |
| 173-179 | `SET_TAG_MAP` | セマンティックカテゴリ→タグのマッピング |
| 182 | `SYSTEM$CLASSIFY` | 自動分類を実行 |
| 196-203 | `TAG_REFERENCES_ALL_COLUMNS` | タグ付け結果を確認 |

💬 **説明ポイント**:
> 「Snowflakeは、名前、電話番号、メールアドレスなどの機密データを自動的に検出してタグ付けできます。データガバナンスの第一歩です。」

---

### セクション3: マスキングポリシー（行205-258）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 224-232 | `CREATE MASKING POLICY mask_string_pii` | ロールに応じてマスク |
| 244-246 | `ALTER TAG governance.pii SET MASKING POLICY` | タグにポリシーを適用 |
| 252-253 | `USE ROLE public; SELECT...` | **デモ**: マスクされる |
| 256-257 | `USE ROLE tb_admin; SELECT...` | **デモ**: マスクされない |

💬 **説明ポイント**:
> 「マスキングポリシーを使うと、ロールに応じてデータを隠せます。ACCOUNTADMIN以外には『****MASKED****』と表示されます。同じテーブルでも、見る人によって見える内容が変わります。」

🎭 **デモ**: ロールを切り替えて、同じクエリの結果が変わることを見せる

---

### セクション4: 行アクセスポリシー（行259-326）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 278-279 | `CREATE TABLE governance.row_policy_map` | ロール→国のマッピング |
| 286-287 | `INSERT ... VALUES('tb_data_engineer', 'United States')` | データエンジニアはUS顧客のみ |
| 295-305 | `CREATE ROW ACCESS POLICY` | 行アクセスポリシー |
| 315-318 | `USE ROLE tb_data_engineer; SELECT...` | **デモ**: US顧客のみ表示 |

💬 **説明ポイント**:
> 「行アクセスポリシーは、ロールに応じて見える行を制限します。日本の担当者には日本の顧客のみ、米国の担当者には米国の顧客のみ、というような制御ができます。」

---

### セクション5: DMF（行327-405）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 348 | `SNOWFLAKE.CORE.NULL_PERCENT` | NULLの割合 |
| 351 | `SNOWFLAKE.CORE.DUPLICATE_COUNT` | 重複数 |
| 362-373 | `CREATE DATA METRIC FUNCTION` | カスタムDMF |

💬 **説明ポイント**:
> 「データメトリック関数（DMF）を使うと、データ品質を自動監視できます。NULLの割合、重複数、カスタムルールなどを定義し、スケジュール実行できます。」

---

### セクション6: トラストセンター（行406-486）

💬 **説明ポイント**:
> 「トラストセンターは、アカウント全体のセキュリティを監視します。MFA未設定のユーザー、過剰な権限を持つロール、非アクティブユーザーなどを検出できます。」

🖥️ **UIデモ**: Governance & Security → Trust Center を表示

---

## Module 05: アプリとコラボレーション

### 📁 ファイル: `05_apps_collaboration/05_apps_collaboration.sql`

### セクション1: Marketplace（行23-58）

💬 **説明ポイント**:
> 「Snowflake Marketplaceでは、サードパーティのデータを即座に取得できます。データはコピーされず、ライブで共有されます。Weather Sourceの天気データを取得してみましょう。」

🖥️ **UIデモ**: Marketplace → 検索 → Get の流れを見せる

---

### セクション2: 天気データとの統合（行59-168）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 66-74 | 天気データの確認 | 都市別の平均気温、風速など |
| 77-91 | `CREATE VIEW harmonized.daily_weather_v` | 天気データとロケーションを結合 |
| 120-152 | `CREATE VIEW analytics.daily_sales_by_weather_v` | 売上と天気を結合 |
| 160-166 | 大雨時の売上分析 | シアトルで降水量1インチ以上の日 |

💬 **説明ポイント**:
> 「Marketplaceから取得した天気データと、自社の売上データを結合することで、天気が売上にどう影響するかを分析できます。これがデータコラボレーションの力です。」

---

### セクション3: POIデータ（行169-284）

| 行番号 | SQL | 説明ポイント |
|-------|-----|-------------|
| 188-204 | `CREATE VIEW harmonized.tastybytes_poi_v` | SafegraphのPOIデータと結合 |
| 207-220 | 風の強いロケーションTOP3 | 天気×POI |
| 237-265 | 穏やかな日 vs 風の強い日 | CTE + 条件付き集計 |

💬 **説明ポイント**:
> 「SafegraphのPOI（Point of Interest）データを使うと、店舗の位置情報を活用できます。風の強いロケーションを特定し、そこでの売上を分析することで、天候リスクを可視化できます。」

---

## 🛠️ トラブルシューティング

### よくある問題と対処法

| 問題 | 原因 | 対処法 |
|-----|------|-------|
| 「Object does not exist」エラー | セットアップ未完了 | 00_setup.sqlを再実行 |
| 「Insufficient privileges」エラー | ロール権限不足 | 正しいロールに切り替え |
| クエリが遅い | ウェアハウスサイズ | サイズを一時的にLargeに |
| Cortex関数エラー | リージョン制限 | Cross-region設定を確認 |
| Marketplace取得エラー | ACCOUNTADMINが必要 | ロールを確認 |
| Dynamic Table更新されない | LAG時間内 | 最大1-2分待つ |

### 緊急時の対応

```sql
-- 全ロールの確認
SHOW ROLES;

-- 現在のロール確認
SELECT CURRENT_ROLE();

-- ウェアハウス状態確認
SHOW WAREHOUSES;

-- データベース確認
SHOW DATABASES LIKE 'TB_101';

-- セットアップ状態確認
SELECT COUNT(*) FROM tb_101.raw_pos.order_header;
-- 期待値: 約62,000,000行
```

---

## 📊 参加者フィードバック収集

ハンズオン終了後に以下の項目についてフィードバックを収集することをお勧めします：

1. 各モジュールの難易度（1-5）
2. 最も役立ったモジュール
3. 追加で学びたいトピック
4. 改善点・要望

---

## 📞 サポート連絡先

技術的な問題が発生した場合：
- Snowflake サポート: support.snowflake.com
- 社内担当者: [担当者名・連絡先を記入]

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|-----|-----------|---------|
| 2025-01 | v2.0 | 初版作成 |
| 2025-01 | v2.1 | モジュール別詳細ガイド追加 |
